name: Auto-stamp KB (Last updated + Build + Last synced)

on:
  push:
    branches: [ "main" ]
    paths:
      - "**/*.md"
      - "docs/**"
      - "libraries/**"
      - "scripts/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  stamp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set TZ & build stamps
        shell: bash
        run: |
          set -euo pipefail
          sudo timedatectl set-timezone Europe/Athens || true
          NOW="$(date '+%d/%m/%Y – %H:%M')"
          SHA="${GITHUB_SHA::7}"
          echo "NOW<<EOF" >> $GITHUB_ENV
          echo "$NOW" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "SHA=$SHA" >> $GITHUB_ENV

      - name: Normalize KB headers (idempotent, UTF-8, no stray *)
        shell: bash
        run: |
          set -euo pipefail
          git config --global core.quotepath false
          export LANG=C.UTF-8 LC_ALL=C.UTF-8

          git ls-files -z -- '*.md' 'docs/**/*.md' 'libraries/**/*.md' 'scripts/**/*.md' |
          while IFS= read -r -d '' f; do
            # Normalize CRLF → LF
            sed -i 's/
$//' "$f"

            # Rebuild top 3-line header exactly once; remove any previous header/stray "*" at top
            awk -v NOW="$NOW" -v SHA="$SHA" '
              BEGIN{
                lu="*Last updated:* " NOW " (Europe/Athens)";
                ls="*Last synced with VERSIONS_INDEX.md:* " NOW " (DEV-only)";
                bd="*Build:* " SHA;
                printed=0;
              }
              # skip any pre-existing header noise in the first 20 lines:
              NR<=20 && (
                  $0 ~ /^\*?Last updated:/ ||
                  $0 ~ /^\*?Last synced with VERSIONS_INDEX\.md:/ ||
                  $0 ~ /^\*?Build:/ ||
                  $0 ~ /^[[:space:]]*\*+[[:space:]]*$/ ||
                  $0 ~ /^[[:space:]]*$/
              ) { next }
              {
                if (printed==0) {
                  print lu; print ls; print bd; print "";
                  printed=1;
                }
                print
              }
              END{
                if (printed==0) { print lu; print ls; print bd; print "" }
              }
            ' "$f" > "$f.__tmp" && mv "$f.__tmp" "$f"

            # Collapse 2+ blank runs to a single blank line
            awk 'BEGIN{b=0} { if($0~/^[[:space:]]*$/){ if(b) next; b=1; print "" } else { b=0; print } }' "$f" > "$f.__tmp" && mv "$f.__tmp" "$f"
          done

      - name: Commit & push stamps
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore(kb-stamp): Update Last updated / Last synced / Build"
            git push
          else
            echo "No changes to commit."
          fi
